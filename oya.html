<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>親機</title>
</head>

<body>
  <h1>早押しクイズ - 親機</h1>
  <button id="startButton">接続開始</button>
  <button id="buzzerButton" disabled>ブザーを鳴らす</button>
  <button id="correctButton">正解音を鳴らす</button>
  <button id="wrongButton">不正解音を鳴らす</button>

  <script>
    const signalingServerUrl = "wss://hayaoshi-quiz-backend.onrender.com/";
    let localConnection;
    let dataChannel;

    document.getElementById("startButton").addEventListener("click", async () => {
      localConnection = new RTCPeerConnection();

      // シグナリングサーバーに接続
      const ws = new WebSocket(signalingServerUrl);
      ws.onopen = () => {
        console.log("WebSocket connection established.");
      };

      // DataChannelの作成
      dataChannel = localConnection.createDataChannel("quiz");
      dataChannel.onopen = () => {
        console.log("DataChannel is open");
        document.getElementById("buzzerButton").disabled = false;
      };
      dataChannel.onmessage = (event) => {
        console.log("Message from child:", event.data);
        // 子機からのメッセージに応じて、音を鳴らす
        if (event.data === "pressed") {
          const audio = new Audio('assets/audio/Quiz-Buzzer02-1.mp3');
          audio.play();
        }
      };

      // シグナリングメッセージの送信
      localConnection.onicecandidate = (event) => {
        if (event.candidate) {
          ws.send(JSON.stringify({candidate: event.candidate}));
        }
      };

      // WebSocketでOfferを送信
      const offer = await localConnection.createOffer();
      await localConnection.setLocalDescription(offer);
      ws.send(JSON.stringify({offer}));

      ws.onmessage = async (message) => {
        const data = JSON.parse(message.data);
        if (data.answer) {
          await localConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        } else if (data.candidate) {
          await localConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
        }
      };
    });

    document.getElementById("buzzerButton").addEventListener("click", () => {
      if (dataChannel && dataChannel.readyState === "open") {
        dataChannel.send("buzzer");
      }
    });

    // 正解音を鳴らす
    document.getElementById("correctButton").addEventListener("click", () => {
      const correctSound = new Audio('assets/audio/correct1.mp3');
      correctSound.play();
    });

    // 不正解音を鳴らす
    document.getElementById("wrongButton").addEventListener("click", () => {
      const wrongSound = new Audio('assets/audio/Quiz-Wrong_Buzzer02-1.mp3');
      wrongSound.play();
    });
  </script>
</body>

</html>
