<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>早押しクイズ - 親機</title>
  </head>

  <body>
    <h1>早押しクイズ 親機</h1>
    <button id="start-btn">ゲーム開始</button>
    <p id="winner">待機中...</p>

    <audio id="buzzer-sound" src="assets/audio/Quiz-Buzzer02-1.mp3"></audio>
    <audio id="correct-sound" src="assets/audio/correct1.mp3"></audio>
    <audio
      id="wrong-sound"
      src="assets/audio/Quiz-Wrong_Buzzer02-1.mp3"
    ></audio>

    <button id="correct-btn" disabled>正解</button>
    <button id="wrong-btn" disabled>不正解</button>

    <script>
      const startBtn = document.getElementById("start-btn");
      const winnerDisplay = document.getElementById("winner");
      const buzzerSound = document.getElementById("buzzer-sound");
      const correctSound = document.getElementById("correct-sound");
      const wrongSound = document.getElementById("wrong-sound");
      const correctBtn = document.getElementById("correct-btn");
      const wrongBtn = document.getElementById("wrong-btn");

      let currentWinner = null;

      let peerConnection = new RTCPeerConnection();
      let dataChannel = peerConnection.createDataChannel("quizChannel");

      // シグナリングサーバーと接続
      let signalingSocket = new WebSocket(
        "wss://hayaoshi-quiz-backend.onrender.com",
      );

      signalingSocket.onmessage = async (event) => {
        const message = JSON.parse(event.data);
        if (message.type === "offer") {
          await peerConnection.setRemoteDescription(
            new RTCSessionDescription(message.offer),
          );
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          signalingSocket.send(JSON.stringify({ type: "answer", answer }));
        } else if (message.type === "candidate") {
          await peerConnection.addIceCandidate(
            new RTCIceCandidate(message.candidate),
          );
        }
      };

      // ICE candidateの送信
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          signalingSocket.send(
            JSON.stringify({ type: "candidate", candidate: event.candidate }),
          );
        }
      };

      dataChannel.onmessage = (event) => {
        const message = JSON.parse(event.data);
        if (message.type === "buzz") {
          buzzerSound.play();
          currentWinner = message.name;
          winnerDisplay.textContent = `Winner: ${currentWinner}`;
          correctBtn.disabled = false;
          wrongBtn.disabled = false;
        }
      };

      startBtn.addEventListener("click", () => {
        winnerDisplay.textContent = "待機中...";
        correctBtn.disabled = true;
        wrongBtn.disabled = true;
      });

      correctBtn.addEventListener("click", () => {
        const resultMessage = {
          type: "result",
          result: "correct",
          name: currentWinner,
        };
        dataChannel.send(JSON.stringify(resultMessage));
        correctSound.play();
        correctBtn.disabled = true;
        wrongBtn.disabled = true;
      });

      wrongBtn.addEventListener("click", () => {
        const resultMessage = {
          type: "result",
          result: "wrong",
          name: currentWinner,
        };
        dataChannel.send(JSON.stringify(resultMessage));
        wrongSound.play();
        correctBtn.disabled = true;
        wrongBtn.disabled = true;
      });
    </script>
  </body>
</html>
