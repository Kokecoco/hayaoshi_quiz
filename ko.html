<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>子機</title>
</head>

<body>
  <h1>早押しクイズ - 子機</h1>
  <button id="pressButton" disabled>ボタンを押す</button>

  <script>
    const signalingServerUrl = "wss://hayaoshi-quiz-backend.onrender.com/";
    let remoteConnection;

    document.getElementById("pressButton").addEventListener("click", () => {
      if (dataChannel && dataChannel.readyState === "open") {
        dataChannel.send("pressed");
      }
    });

    const ws = new WebSocket(signalingServerUrl);
    ws.onopen = () => {
      console.log("WebSocket connection established.");
    };

    // WebSocketでOfferを受信
    ws.onmessage = async (message) => {
      const data = JSON.parse(message.data);
      if (data.offer) {
        remoteConnection = new RTCPeerConnection();

        remoteConnection.onicecandidate = (event) => {
          if (event.candidate) {
            ws.send(JSON.stringify({candidate: event.candidate}));
          }
        };

        remoteConnection.ondatachannel = (event) => {
          dataChannel = event.channel;
          dataChannel.onopen = () => {
            console.log("DataChannel is open");
            document.getElementById("pressButton").disabled = false;
          };
        };

        await remoteConnection.setRemoteDescription(new RTCSessionDescription(data.offer));
        const answer = await remoteConnection.createAnswer();
        await remoteConnection.setLocalDescription(answer);
        ws.send(JSON.stringify({answer}));
      } else if (data.candidate) {
        await remoteConnection.addIceCandidate(new RTCIceCandidate(data.candidate));
      }
    };
  </script>
</body>

</html>
