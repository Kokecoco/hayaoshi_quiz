<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>子機 - 早押しクイズ</title>
  </head>

  <body>
    <h1>早押しクイズ - 子機</h1>
    <input type="text" id="nameInput" placeholder="名前を入力" />
    <button id="buzzBtn" disabled>早押し！</button>

    <script>
      let peerConnection;
      let dataChannel;
      const socket = new WebSocket("wss://hayaoshi-quiz-backend.onrender.com");

      socket.onopen = () => {
        console.log("WebSocket connected.");
      };

      document.getElementById("buzzBtn").addEventListener("click", () => {
        if (dataChannel && dataChannel.readyState === "open") {
          const buzzMessage = {
            type: "buzz",
            name: document.getElementById("nameInput").value,
          };
          dataChannel.send(JSON.stringify(buzzMessage));
        } else {
          console.error("Data channel is not open yet.");
        }
      });

      socket.onmessage = async (message) => {
        const data = JSON.parse(message.data);
        if (data.type === "offer") {
          peerConnection = new RTCPeerConnection();
          peerConnection.ondatachannel = (event) => {
            dataChannel = event.channel;
            dataChannel.onopen = () => {
              console.log("Data channel is open.");
              document.getElementById("buzzBtn").disabled = false; // ボタンを有効化
            };
            dataChannel.onmessage = (event) => {
              const response = JSON.parse(event.data);
              if (response.type === "correct") {
                alert("正解です！");
              } else if (response.type === "wrong") {
                alert("不正解です！");
              }
            };
          };

          await peerConnection.setRemoteDescription(
            new RTCSessionDescription(data.offer),
          );
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          socket.send(
            JSON.stringify({
              type: "answer",
              answer: peerConnection.localDescription,
            }),
          );
        }
      };
    </script>
  </body>
</html>
