<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>早押しクイズ - 子機</title>
  </head>

  <body>
    <h1>早押しクイズ 子機</h1>
    <input type="text" id="nameInput" placeholder="名前を入力してください" />
    <button id="buzzBtn">早押し</button>

    <script>
      const buzzBtn = document.getElementById("buzzBtn");
      const nameInput = document.getElementById("nameInput");
      let peerConnection;
      let dataChannel;

      const signalingServerUrl = "https://hayaoshi-quiz-backend.onrender.com"; // シグナリングサーバーURL
      const socket = new WebSocket(signalingServerUrl);

      buzzBtn.addEventListener("click", () => {
        if (dataChannel && dataChannel.readyState === "open") {
          const buzzMessage = { type: "buzz", name: nameInput.value };
          dataChannel.send(JSON.stringify(buzzMessage));
        } else {
          console.error("Data channel is not open yet.");
        }
      });

      socket.onmessage = async (message) => {
        const data = JSON.parse(message.data);
        if (data.type === "offer") {
          peerConnection = new RTCPeerConnection();
          peerConnection.ondatachannel = (event) => {
            dataChannel = event.channel;
            dataChannel.onopen = () => {
              console.log("Data channel is open and ready to be used.");
            };
            dataChannel.onmessage = (event) => {
              const response = JSON.parse(event.data);
              if (response.type === "correct") {
                alert("正解です！");
              } else if (response.type === "wrong") {
                alert("不正解です！");
              }
            };
          };

          await peerConnection.setRemoteDescription(
            new RTCSessionDescription(data.offer),
          );
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          socket.send(
            JSON.stringify({
              type: "answer",
              answer: peerConnection.localDescription,
            }),
          );
        }
      };
    </script>
  </body>
</html>
