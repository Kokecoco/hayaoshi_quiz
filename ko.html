<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>早押しクイズ - 子機</title>
  </head>

  <body>
    <h1>早押しクイズ 子機</h1>
    <input type="text" id="name-input" placeholder="名前を入力してください" />
    <button id="buzz-btn" disabled>早押し！</button>

    <script>
      const buzzBtn = document.getElementById("buzz-btn");
      const nameInput = document.getElementById("name-input");

      let peerConnection = new RTCPeerConnection();
      let dataChannel;

      // シグナリングサーバーと接続
      let signalingSocket = new WebSocket(
        "wss://hayaoshi-quiz-backend.onrender.com",
      );

      signalingSocket.onopen = async () => {
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        signalingSocket.send(JSON.stringify({ type: "offer", offer }));
      };

      signalingSocket.onmessage = async (event) => {
        const message = JSON.parse(event.data);
        if (message.type === "answer") {
          await peerConnection.setRemoteDescription(
            new RTCSessionDescription(message.answer),
          );
        } else if (message.type === "candidate") {
          await peerConnection.addIceCandidate(
            new RTCIceCandidate(message.candidate),
          );
        }
      };

      peerConnection.ondatachannel = (event) => {
        dataChannel = event.channel;
        dataChannel.onmessage = (event) => {
          const message = JSON.parse(event.data);
          if (message.type === "result") {
            if (
              message.result === "correct" &&
              message.name === nameInput.value
            ) {
              alert("正解！");
            } else if (
              message.result === "wrong" &&
              message.name === nameInput.value
            ) {
              alert("不正解...");
            }
          }
        };
      };

      nameInput.addEventListener("input", () => {
        buzzBtn.disabled = !nameInput.value;
      });

      buzzBtn.addEventListener("click", () => {
        const buzzMessage = { type: "buzz", name: nameInput.value };
        dataChannel.send(JSON.stringify(buzzMessage));
      });

      // ICE candidateの送信
      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          signalingSocket.send(
            JSON.stringify({ type: "candidate", candidate: event.candidate }),
          );
        }
      };
    </script>
  </body>
</html>
